# Development Workflow

This guide describes the development workflow for CRYOLITE contributors.

## Prerequisites

- **Java 21+** - Required for building and running
- **Maven 3.9+** - Build tool
- **Docker & Docker Compose** - For integration tests
- **Git** - Version control

## Initial Setup

### 1. Clone Repository

```bash
git clone https://github.com/cryolite-io/cryolite.git
cd cryolite
```

### 2. Configure Environment

```bash
# Copy example configuration
cp .env.example .env

# Edit .env and set your values
nano .env
```

**Required Variables**:
- `SONAR_TOKEN` - Get from https://sonarcloud.io/account/security
- `POLARIS_CLIENT_ID` / `POLARIS_CLIENT_SECRET` - Auto-generated by Docker setup
- `NVD_API_KEY` (optional) - Get from https://nvd.nist.gov/developers/request-an-api-key

### 3. Install Git Hooks

```bash
./scripts/hooks/install-hooks.sh

# Verify installation
ls -la .git/hooks/pre-commit .git/hooks/commit-msg
```

### 4. Start Docker Services

```bash
make docker-up

# Get auto-generated Polaris credentials
docker logs cryolite-polaris-setup | grep "POLARIS_CLIENT_ID"

# Copy credentials to .env file
```

## Development Cycle

### 1. Create Feature Branch

```bash
git checkout -b feature/my-feature
```

### 2. Make Changes

Edit code, add tests, update documentation.

### 3. Run Tests Locally

```bash
# Format code
make format

# Run tests
make test

# Check coverage (85% minimum)
make coverage

# Run all checks
make verify
```

### 4. Commit Changes

```bash
git add .
git commit -m "feat: add new feature"
```

**Commit Message Format** (Conventional Commits):
- `feat:` - New feature
- `fix:` - Bug fix
- `refactor:` - Code refactoring
- `test:` - Add or update tests
- `docs:` - Documentation changes
- `build:` - Build system changes
- `chore:` - Maintenance tasks

**Pre-Commit Hooks** will automatically:
1. Format code with Spotless
2. Run all tests with coverage
3. Check dependencies for vulnerabilities
4. Run SonarCloud analysis
5. Block commit if any check fails

### 5. Push Changes

```bash
git push origin feature/my-feature
```

### 6. Create Pull Request

1. Go to GitHub repository
2. Click "New Pull Request"
3. Select your branch
4. Fill in PR description
5. Wait for CI checks to pass
6. Request review

## Makefile Commands

The project uses a Makefile for centralized build commands:

```bash
make help                # Show all available commands
make format              # Format code with Spotless
make test                # Run all tests
make coverage            # Check test coverage (85% minimum)
make quality             # Run SonarCloud analysis
make dependency-check    # Check dependencies for vulnerabilities
make verify              # Run all checks (format + test + coverage + dependency-check)
make verify-with-quality # Run all checks including SonarCloud
make docker-up           # Start Docker services
make docker-down         # Stop Docker services
make clean               # Clean build artifacts
```

## Quality Standards

### Test Coverage

- **Minimum**: 85% line coverage (enforced by JaCoCo)
- **Target**: 100% for own logic
- **Exclusions**: DTOs, adapters (if not meaningful)

### Code Style

- **Format**: Google Java Format (enforced by Spotless)
- **Linting**: SonarCloud (no critical/high issues)
- **Security**: OWASP Dependency Check (CVSS ≥ 7.0 fails build)

### Commit Messages

- **Format**: Conventional Commits
- **Validation**: Enforced by commit-msg hook
- **Examples**:
  - `feat: add table writer for partitioned tables`
  - `fix: resolve MinIO double-slash path issue`
  - `test: add S3 storage verification to write tests`

## Testing Strategy

### Unit Tests

- Test individual classes in isolation
- Mock external dependencies
- Fast execution (< 1 second per test)

### Integration Tests

- Test against real services (Polaris + MinIO)
- Extend `AbstractIntegrationTest`
- Use unique resource names (`uniqueSuffix()`)

### Test Naming

```java
@Test
void testMethodName_Scenario_ExpectedBehavior() {
    // Arrange
    // Act
    // Assert
}
```

## Debugging

### View Service Logs

```bash
# All services
docker compose logs -f

# Specific service
docker compose logs -f polaris
docker compose logs -f minio
```

### Access Services

- **Polaris API**: http://localhost:8181/api/catalog
- **Polaris Health**: http://localhost:8182/q/health
- **MinIO Console**: http://localhost:9001 (minioadmin / minioadmin)
- **MinIO API**: http://localhost:9000

### Run Single Test

```bash
mvn test -Dtest=MyTest#testMethod
```

## Troubleshooting

### Tests Fail Locally

1. Check Docker services are running: `docker compose ps`
2. Check service health: `curl http://localhost:8182/q/health`
3. Restart services: `make docker-down && make docker-up`
4. Check logs: `docker compose logs`

### Pre-Commit Hook Fails

1. Run checks manually: `make verify-with-quality`
2. Fix issues reported
3. Commit again

### SonarCloud Fails

1. Check token is set: `echo $SONAR_TOKEN`
2. Run locally: `make quality`
3. Fix reported issues
4. Commit again

## CI/CD Pipeline

### GitHub Actions

The CI pipeline runs on every push and PR:

1. **Build**: Compile code
2. **Test**: Run all tests
3. **Coverage**: Check 85% minimum
4. **Quality**: SonarCloud analysis
5. **Security**: Dependency check

### Quality Gates

All checks must pass before merge:

- ✅ Build successful
- ✅ All tests pass
- ✅ Coverage ≥ 85%
- ✅ SonarCloud quality gate passed
- ✅ No critical/high security vulnerabilities

## Release Process

(To be defined in future milestones)

## Getting Help

- **Issues**: https://github.com/cryolite-io/cryolite/issues
- **Discussions**: https://github.com/cryolite-io/cryolite/discussions
- **Contributing**: See [CONTRIBUTING.md](../../CONTRIBUTING.md)

## Related Documentation

- [Architecture Overview](../README.md#architecture-overview)
- [API Reference](../api/)
- [Testing Guide](../testing/)

