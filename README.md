# CRYOLITE

**C**RYOLITE **R**uns **Y**our **O**pen **L**ightweight **I**ceberg **T**able **E**ngine *(recursive acronym)*

An embedded, lightweight Apache Iceberg table and query engine for Java applications.

## Features

- **Embedded Library**: No CLI, no server, no REST service
- **Single-Node**: Local execution only
- **JVM-First**: Designed for Java applications
- **Educational**: Clean, readable, and well-documented code
- **Production-Ready**: Real optimizations, not toy code

## Quick Start

### Prerequisites

- Java 21+
- Maven 3.9+
- Docker & Docker Compose (for Polaris + MinIO)

### Setup

1. **Clone the repository**
   ```bash
   git clone https://github.com/cryolite-io/cryolite.git
   cd cryolite
   ```

2. **Configure environment variables**
   ```bash
   # Copy the example configuration
   cp .env.example .env

   # Edit .env and set your SonarCloud token
   # Get your token from: https://sonarcloud.io/account/security
   nano .env  # or use your preferred editor
   ```

3. **Install Git hooks** (required for contributors)
   ```bash
   # Install hooks using the provided script
   ./scripts/hooks/install-hooks.sh

   # Verify installation
   ls -la .git/hooks/pre-commit .git/hooks/commit-msg
   ```

4. **Start Docker services** (Polaris + MinIO + PostgreSQL)
   ```bash
   make docker-up

   # Get auto-generated Polaris credentials
   docker logs cryolite-polaris-setup | grep "POLARIS_CLIENT_ID"

   # Copy the credentials to your .env file
   ```

5. **Build and test**
   ```bash
   # Run all tests (Makefile automatically loads .env)
   make test
   ```

## Development

### Makefile Commands

The project uses a **Makefile** for centralized build command management. The Makefile automatically loads the `.env` file.

```bash
make help                # Show all available commands
make format              # Format code with Spotless
make test                # Run all tests
make coverage            # Check test coverage (85% minimum)
make quality             # Run SonarCloud analysis
make dependency-check    # Check dependencies for vulnerabilities
make verify              # Run all checks (format + test + coverage + dependency-check)
make verify-with-quality # Run all checks including SonarCloud
make docker-up           # Start Docker services
make docker-down         # Stop Docker services
make clean               # Clean build artifacts
```

### Environment Configuration

All configuration is centralized in the `.env` file:

```bash
# Create your local configuration
cp .env.example .env

# Edit and set your values
nano .env
```

**Required variables:**
- `SONAR_TOKEN` - Get from https://sonarcloud.io/account/security
- `POLARIS_CLIENT_ID` / `POLARIS_CLIENT_SECRET` - Auto-generated by Docker setup

**Optional variables:**
- `NVD_API_KEY` - Get from https://nvd.nist.gov/developers/request-an-api-key (speeds up dependency checks)

**Important**: The `.env` file contains secrets and is in `.gitignore`. Never commit it!

### Pre-Commit Hooks

The project uses Git hooks for quality assurance. All checks run automatically before each commit via `make verify-with-quality`:

1. ✅ Format code with Spotless
2. ✅ Run all tests with coverage (85% minimum)
3. ✅ Check dependencies for vulnerabilities (CVSS ≥ 7.0)
4. ✅ Analyze code with SonarCloud
5. ❌ Block commit if any check fails

**Git hooks are stored in `.git/hooks/`** and must be installed by each contributor. See [CONTRIBUTING.md](CONTRIBUTING.md) for setup instructions.

### Manual Quality Checks

```bash
# Format code
make format

# Run tests with coverage
make test

# Run all verification checks
make verify

# Run pre-commit hook manually
.git/hooks/pre-commit
```

## Project Structure

```
cryolite/
├── src/main/java/io/cryolite/     # Main source code
├── src/test/java/io/cryolite/     # Unit tests (85%+ coverage)
├── docs/                           # Detailed documentation
├── pom.xml                         # Maven configuration
├── Makefile                        # Centralized build commands
├── docker-compose.yml              # Docker services (Polaris + MinIO + PostgreSQL)
├── .env                            # Environment variables (secrets, not committed)
├── .env.example                    # Example configuration template
├── scripts/hooks/                  # Git hook templates
├── .github/dependabot.yml          # Automated dependency updates
├── LICENSE                         # Apache License 2.0
├── README.md                       # This file
├── CONTRIBUTING.md                 # Contribution guidelines
└── .gitignore                      # Git ignore rules
```

For detailed documentation, see the [docs/](docs/) directory.

## Milestones

### ✅ M0 – Project Foundation (Completed)

- ✅ Maven build with dependencies
- ✅ Docker Compose (Polaris + MinIO)
- ✅ Quality gates (Spotless, JUnit, SonarCloud)
- ✅ Git hooks (pre-commit, commit-msg)
- ✅ Conventional Commits validation
- ✅ Apache License 2.0
- ✅ Contributing guidelines

### ✅ M1 – Embedded Skeleton + Configuration (Completed)

- ✅ `CryoliteEngine` - Main entry point with lifecycle (create/close)
- ✅ `CryoliteConfig` - Immutable configuration with Builder pattern
- ✅ `CatalogManager` - Polaris REST Catalog connection
- ✅ Health checks for Polaris connectivity
- ✅ Full integration with Docker Compose services

### ✅ M2 – Low-Level DDL: Namespace + Table Create (Completed)

- ✅ Simplified architecture: Iceberg Catalog is the low-level API
- ✅ Removed unnecessary abstractions (StorageManager, NamespaceManager, TableManager)
- ✅ Polaris handles credential vending for storage access
- ✅ Namespace operations via `SupportsNamespaces` interface
- ✅ Table operations via `Catalog` interface
- ✅ Configured Polaris with `DROP_WITH_PURGE_ENABLED`
- ✅ Created Makefile for centralized build commands
- ✅ Added OWASP Dependency Check (CVSS ≥ 7.0)
- ✅ Added Dependabot for automated dependency updates
- ✅ 43 unit tests with 85%+ coverage

### ✅ M3 – Low-Level DML: Write Path (Completed)

- ✅ `TableWriter` class for writing data to Iceberg tables
- ✅ Support for both partitioned and unpartitioned tables
- ✅ Automatic partition routing with `PartitionedFanoutWriter`
- ✅ Snapshot creation and commit
- ✅ Parquet file format
- ✅ S3-compatible storage verification in tests
- ✅ `S3StorageTestHelper` for end-to-end storage verification
- ✅ 49 integration tests with 85%+ coverage
- ✅ All tests verify both Iceberg metadata and physical files

### Current: M4 – Low-Level Read: Scan + Arrow Result

Coming soon...

## Contributing

We welcome contributions! Please see [CONTRIBUTING.md](CONTRIBUTING.md) for:
- Development setup
- Commit message guidelines
- Code quality standards
- Testing requirements
- Pull request process

## License

This project is licensed under the Apache License 2.0 - see [LICENSE](LICENSE) file for details.

## Code Quality

- **Test Coverage**: Minimum 85% line coverage (enforced by JaCoCo)
- **Code Style**: Google Java Format (enforced by Spotless)
- **Quality Gate**: SonarCloud (no critical/high issues)
- **Security**: OWASP Dependency Check (CVSS ≥ 7.0 fails build)
- **Commits**: Conventional Commits format
- **Dependencies**: Dependabot for automated updates

