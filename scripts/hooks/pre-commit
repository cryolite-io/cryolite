#!/bin/bash
# Pre-commit hook for CRYOLITE
# Runs: code formatting, tests with coverage check, and SonarCloud analysis
# This hook ensures code quality before every commit

set -e

echo "üîç Running pre-commit checks..."

# Load environment variables
if [ -f .env ]; then
  export $(cat .env | grep -v '^#' | xargs)
fi

# 1. Code formatting with Spotless
echo "üìù Formatting code with Spotless..."
mvn spotless:apply -q

# Add any files that were formatted by Spotless to the commit
if ! git diff --quiet; then
  echo "üìù Spotless formatted some files, adding them to the commit..."
  git add -u
fi

# 2. Run tests with coverage check (minimum 85%)
echo "üß™ Running tests with coverage check (minimum 85%)..."
mvn clean test -q
if [ $? -ne 0 ]; then
  echo "‚ùå Tests failed or coverage below 85%"
  exit 1
fi

# 3. SonarCloud analysis (REQUIRED - no skipping)
echo "üìä Running SonarCloud analysis..."
export SONAR_HOST_URL="${SONAR_HOST_URL:-https://sonarcloud.io}"
export SONAR_TOKEN="${SONAR_TOKEN}"
export SONAR_PROJECT_KEY="${SONAR_PROJECT_KEY:-cryolite-io_cryolite}"
export SONAR_ORGANIZATION="${SONAR_ORGANIZATION:-cryolite-io}"

if [ -z "$SONAR_TOKEN" ]; then
  echo "‚ùå Error: SONAR_TOKEN not set in .env"
  exit 1
fi

# Run SonarCloud analysis and wait for quality gate
sonar-scanner \
  -Dsonar.projectKey="${SONAR_PROJECT_KEY}" \
  -Dsonar.organization="${SONAR_ORGANIZATION}" \
  -Dsonar.sources=src/main \
  -Dsonar.tests=src/test \
  -Dsonar.java.binaries=target/classes \
  -Dsonar.java.test.binaries=target/test-classes \
  -Dsonar.coverage.jacoco.xmlReportPaths=target/site/jacoco/jacoco.xml \
  -Dsonar.qualitygate.wait=true

if [ $? -ne 0 ]; then
  echo "‚ùå SonarCloud analysis failed or quality gate not passed"
  exit 1
fi

echo "‚úÖ All pre-commit checks passed!"
echo "üìå Review SonarCloud results at: https://sonarcloud.io/organizations/cryolite-io/projects"

